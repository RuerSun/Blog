---
layout:     post
title:      "SIP 教程(九) 移动性, 2020"
subtitle:   "SIP"
date:       2020-09-10 08:54:00
author:     "Ruer"
header-img: "img/bg/hello_world.jpg"
catalog: true
tags:
    - SIP
---

有时，代理服务器将单个 SIP 呼叫转发到多个 SIP 端点。这个过程被称为分叉。这里单个呼叫可以同时响铃多个端点。

使用 SIP 分叉，您可以让您的桌面电话与手机上的软件电话或 SIP 电话同时响铃，从而可以轻松地从任一设备接听电话。

一般来说，在办公室里，假设老板无法接听电话或离开，SIP 分机允许秘书接听电话他的分机。

我们有两种类型的分叉：`平行分叉`、`顺序分叉`。

## 平行分叉

在这种情况下，代理服务器将把 INVITE 分叉到例如两个设备(UA2、UA3)。两个设备将产生180响铃，并且接收呼叫的任何人将产生 200 OK。首先到达发起者的响应(假设UA2)将与 UA2 建立会话。对于其他响应，将触发 CANCEL。

![1](/img/SIP/平行分叉.jpg)

如果发起者同时接收到这两个响应，则基于 q 值，它将转发响应。

## 顺序分叉

在这种情况下，代理服务器将 INVITE 分叉到一个设备(UA2)。如果 UA2 在那时不可用或忙，则代理将它分配到另一个设备(UA3)。

![2](/img/SIP/顺序分叉.jpg)

## 分支 - ID和标签

分支标识帮助代理匹配对分叉请求的响应。没有分支 ID，代理服务器将无法了解分叉响应。分支标识将在 Via 标头中可用。

标签由 UAC 使用以区分来自不同 UAS 的多个最终响应。UAS 无法解析请求是否已分叉。因此，它需要添加一个标签。

代理还可以添加标签，如果它生成最终响应，他们从来不插入标签到请求或响应他们转发。

也有可能单个请求也可以由多个代理服务器分叉。因此，fork 的代理将向它创建的分支添加自己的唯一 ID。

## 呼叫支路和呼叫 ID

呼叫支路是指两个用户代理之间的一对一信令关系。呼叫 ID 是参考呼叫的 SIP 消息中携带的唯一标识符。呼叫是呼叫线路的集合。

UAC 通过发送 INVITE 开始。由于分叉，它可以从不同的 UA 接收多个 200 OK。每个对应于相同呼叫中的不同呼叫支路。

因此，呼叫是一组呼叫支路。呼叫支路是指 UA 之间的端到端连接。

呼叫支路的两个方向上的 CSeq 空间是独立的。 在单个方向上，序列号对于每个事务递增。

![3](/img/SIP/呼叫支路和呼叫ID.jpg)

## 语音邮件

对于企业用户来说，语音邮件是非常普遍的。这是一个电话应用程序。谈到图片，当被叫方不可用或无法接收呼叫时，PBX 将通知主叫方留下语音消息。

如果被叫方的号码不可达，用户代理将获得 3xx 响应或重定向到语音邮件服务器。然而，需要某种 SIP 分机来向语音邮件系统指示要使用哪个邮箱。即播放哪个问候语以及在哪里存储所记录的消息。有两种方法来实现这一点：

* 通过使用 SIP 头字段扩展
* 通过使用 Request-URI 来发信号通知这个信息

假设用户 `sip:Tom@tutorialspoint.com` 在 `sip:voicemail.w3cschool.cn` 有一个语音邮件系统，它提供语音邮件，当转发到语音邮件服务器时，INVITE 的 Request-URI 可能看起来像：

```
sip:voicemail.tutorialspoint.com;target = sip:Tom@tutorialspoint.com;cause = 486
```

下图显示了 Request-URI 如何携带邮箱标识符和原因(这里为486)。

![4](/img/SIP/语音邮件.jpg)