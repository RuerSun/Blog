---
layout:     post
title:      "ARP 地址解析协议, 2020"
subtitle:   "介绍"
date:       2020-10-08 08:54:00
author:     "Ruer"
header-img: "img/bg/hello_world.jpg"
catalog: true
tags:
    - TCP/IP
---

## 工作原理

1.每个主机都会在自己的 ARP 缓冲区中建立一个 ARP 列表，以表示 IP 地址和 MAC 地址之间的对应关系。  
2.主机（网络接口）新加入网络时（也可能只是mac地址发生变化，接口重启等）， 会发送免费ARP报文把自己IP地址与Mac地址的映射关系广播给其他主机。  
3.网络上的主机接收到免费ARP报文时，会更新自己的ARP缓冲区。将新的映射关系更新到自己的ARP表中。  
4.某个主机需要发送报文时，首先检查 ARP 列表中是否有对应 IP 地址的目的主机的 MAC 地址，如果有，则直接发送数据，如果没有，就向本网段的所有主机发送 ARP 数据包，该数据包包括的内容有：源主机 IP 地址，源主机 MAC 地址，目的主机的 IP 地址等。  
5.当本网络的所有主机收到该 ARP 数据包时：  
    （A）首先检查数据包中的 IP 地址是否是自己的 IP 地址，如果不是，则忽略该数据包。  
    （B）如果是，则首先从数据包中取出源主机的 IP 和 MAC 地址写入到 ARP 列表中，如果已经存在，则覆盖。  
    （C） 然后将自己的 MAC 地址写入 ARP 响应包中，告诉源主机自己是它想要找的 MAC 地址。  
6.源主机收到 ARP 响应包后。将目的主机的 IP 和 MAC 地址写入 ARP 列表，并利用此信息发送数据。如果源主机一直没有收到 ARP 响应数据包，表示 ARP 查询失败。  

## 工作实例

下面我们就来谈一谈ARP地址解析协议是如何把目的地址的IP地址转化成MAC地址的。 

1.首先，主机A想要向主机B发送消息，但它不知道主机B的MAC地址，只知道主机B的IP地址。这时，主机A会在当前局域网下以广播的形式发送ARP请求数据报,表示主机A想知道主机B的MAC地址（注：广播时，以太网首部的目的地址为全f）。 

![1](/img/TCP&IP/ARP广播.png)

2. 由于是广播，所以在本局域网上的所有主机都会受到主机A发送的ARP数据报，然后所有主机会把以太网首部这个报头给去掉，向上面的网络层发送ARP数据报。在这里我们便可以回答上面的问题了，以太网首部和ARP数据报内的MAC地址都不能少，一个是在数据链路层使用的，一个是在网络层使用的，因为两个层都不能看到互相的数据。 

3. 网络层首先会检查op字段，发现这时个ARP请求数据报，然后又会检查目的IP地址字段，检查完毕后，这时除了主机B外，在这个局域网内的其他主机都会把数据报丢弃，因为只有主机B的IP地址和目的IP地址是相同的。

![2](/img/TCP&IP/ARP应答.png)

## 缓存

ARP高速缓存（即ARP表）是 ARP地址解析协议能够高效运行的关键， (如果有多次ARP响应时，以最后一次响应为准)

ARP给IP地址和MAC地址中间做了动态映射，也就是说缓存了一个ARP表，将得到的IP地址和MAC地址对应起来，如果在表中没有查到IP地址对应的MAC地址，就会发广播去找。随着用户的使用，ARP表如果不做任何措施，就会变得越来越臃肿缓慢，就降低了网络传输数据的效率，所以ARP缓存中每一项被设置了生存时间，一般是20分钟，从被创建时开始计算，到时则清除，如果在计时期间又被使用了，计时会重置。

我们可以通过`arp`命令查看arp表： 

![3](/img/TCP&IP/ARP表.png)

ARP表中记录了一些IP地址与物理地址的映射，在arp表中，我们可以看到一个Flags字段，该字段有C、M、P三种取值： 

* C：表明arp条目为通过ARP请求动态获取，（一般存活时间为20min） 
* M：表明arp条目为手动设置。 
* P：表示Publish，表示该ARP条目可以用于恢复其他主机的ARP请求。（用于ARP proxy）

## 报文格式

![4](/img/TCP&IP/ARP报文格式.png)

帧类型：用来向收到数据报的主机表示该数据报的类型，常见类型如下： 
* 0800:IP数据报； 
* 0806:ARP请求/应答数据报； 
* 8035:RAPP请求/应答； 

前14字节是以太网首部帧格式 ,然后后面四个字段描述了本ARP帧涉及的硬件类型和协议类型。 
* Hard Type：该字段占2个字节，指定硬件地址类型， 如值为1表示为以太网地址。 
* Prot Type：该字段占2个字节，指定协议地址类型，如0x0800 表示协议地址类型为IPv4地址。该值与以太帧首部的类型字段相同。 
* Hard Size： 表示硬件地址的大小（单位：字节），如以太网地址为6。
* Prot Size： 表示协议地址的大小（单位：字节）， 如IPv4地址大小为4。（硬件地址长度和协议地址长度，分别占1个字节，指出硬件地址和协议地址的长度，以字节为单位。）

OP ： 表示ARP的消息类型。 
* ARP Request； 
* ARP Reply 
* RARP Request 
* RARP Reply

## 帧的交互

当主机接收到一个针对其协议地址的ARP Request时，它会回应ARP Reply. 该Reply消息内容为：对调sender 和 Target 地址字段，然后将Sender’s Hardware Address（即原来的Target’s Hardware Address ）修改为本机的Hardware Address。另外OP字段有1变为2.

当主机A向本局域网上的主机B发送IP数据报时，先在ARP高速缓存中查找B主机IP所对应的硬件地址，要是找到了，就将此硬件地址写入到MAC帧首部的目的地址中，然后通过局域网发送；要是没有找到，那么主机A会运行ARP，将会按照以下步骤找出主机B的硬件地址。

1.主机A想局域网中广播发送一个ARP请求分组，广播的主要内容是：“我的IP地址是IPA，我的硬件地址是MACA，我要知道IP地址为IPB的主机的硬件地址”。  
2.链路层在接收到这个数据帧之后将有效载荷和报头分离之后，将有效载荷交付给ARP协议进行处理（因为MAC帧首部的帧类型为ARP协议）。  
3.在所有局域网中的主机获得链路层交付的有效载荷后，它们会对其进行处理，发现其中的接收端IP地址与自己的IP地址不同，则会将该数据报丢弃，不做处理。只有B主机会发现接收端IP地址与自己的IP地址相同，此时B主机会向A主机单播一个响应分组（因为通过A的广播，B知道了A的IP地址和硬件地址），“我的IP是IPB，我的硬件地址是MACB”。  
4.在主机A收到主机B的ARP响应分组后，就在ARP的告诉缓存中写入B主机的IP地址到硬件地址的映射。  

## 免费ARP和地址冲突检测

免费ARP指的是主机发送一个ARP请求，求寻找自己的IP地址 。常用在系统引导时，对网络接口进行配置的时候。免费ARP有两个重要作用:

1. 检测网络上是否有其他主机的IP地址与本机相同，即地址冲突检测。 
2. 当主机向网络广播免费ARP时，其实她也将自己的IP地址与物理地址的映射关系广播给其他主机了。因此，如果本机的硬件地址发生了变化，其他主机也应该做出相应的更新。

前面提到的获取目的端的MAC地址的步骤是在一个特殊的条件下完成了，即发送端和目的端都在同一个以太网中，那么当发送端和目的端不在同一个网络中呢。

这种情况下有一个术语叫ARP代理。连接发送端和目的端网络的路由器就充当这样一个代理。举个简单的例子，当主机A发送ARP请求给主机B时，它们处于不同的网络，但是由路由器C相连，当C识别出主机B的IP地址属于它连接的一个主机，这时C就会欺骗主机A，让A误认C就是目的主机，然后C就将ARP数据报发给B，最后B再将ARP应答发回来。

