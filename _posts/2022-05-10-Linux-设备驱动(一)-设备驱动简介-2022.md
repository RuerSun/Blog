---
layout:     post
title:      "Linux 设备驱动(一) 设备驱动简介, 2022"
subtitle:   "欢迎使用"
date:       2022-05-10 19:04:20
author:     "Ruer"
header-img: "img/bg/hello_world.jpg"
catalog: true
tags:
    - Linux
---

## 驱动角色

驱动程序在 Linux 内核里扮演着特殊的角色。它们是截然不同的"黑盒子"，使硬件响应定义好的内部编程接口，它们完全隐藏了设备工作的细节。用户的活动通过一套标准化的调用来进行，这些调用与驱动是独立的。设备驱动的角色就是将这些调用映射到作用于实际硬件的和设备相关的操作上。驱动可以与内核的其他部分分开建立，并在需要的时候"插
入"。

## 内核划分

在 Linux 系统中，几个并发的进程专注于不同的任务。每个进程请求系统资源, 像计算能力、内存、网络连接或者一些别的资源。内核是个大块的可执行文件，负责处理所有这样的请求。尽管不同内核任务间的区别常常不是能清楚划分，内核的角色可以划分成下列几个部分：

* 进程管理

> 内核负责创建和销毁进程，并处理它们与外部的联系。不同进程间通讯对整个系统功能来说是基本的，也由内核处理。另外，调度器控制进程如何共享 CPU，也是进程管理的一部分。更通常内核的进程管理活动实现了多个进程在一个单个或者几个 CPU 之上的抽象。

* 内存管理

> 计算机的内存是主要的资源，处理它所用的策略对系统性能是至关重要的。内核为所有进程的每一个都在有限的可用资源上建立了一个虚拟地址空间。内核的不同部分与内存管理子系统通过一套函数调用交互，从简单的 malloc/free 对到更多更复杂的功能。

* 文件系统

> Linux 在很大程度上基于文件系统的概念。几乎 Linux 中的任何东西都可看作一个文件。内核在非结构化的硬件之上建立了一个结构化的文件系统, 结果是文件的抽象非常多地在整个系统中应用。另外, Linux 支持多个文件系统类型，就是说物理介质上不同的数据组织方式。例如，磁盘可被格式化成标准 Linux 的 ext3 文件系统，普遍使用的 FAT 文件系统，或者其他几个文件系统。

* 设备控制

> 几乎每个系统操作最终都映射到一个物理设备上。除了处理器、内存和非常少的别的实体之外, 全部中的任何设备控制操作都由特定于要寻址的设备相关的代码来进行。这些代码称为设备驱动，内核中必须嵌入系统中出现的每个外设的驱动, 从硬盘驱动到键盘和磁带驱动器。

* 网络

> 网络必须由操作系统来管理，因为大部分网络操作不是特定于某一个进程。进入系统的报文是异步事件，报文在某一个进程接手之前必须被收集、识别、分发。系统负责在程序和网络接口之间递送数据报文，它必须根据程序的网络活动来控制程序的执行。另外，所有的路由和地址解析问题都在内核中实现。

![1](/img/Linux/驱动编程/内核划分.png)

## 可加载模块

Linux 的众多优良特性之一就是可以在运行时扩展由内核提供的特性的能力。这意味着你可以在系统正在运行着的时候增加或去除内核的功能。

每块可以在运行时添加到内核的代码，被称为一个模块。Linux 内核提供了对许多模块类型的支持，包括但不限于设备驱动。每个模块由目标代码组成，可以动态连接到运行中的内核中，通过 `insmod` 程序，以及通过 `rmmod` 程序去连接.

## 设备分类

以 Linux 的方式看待设备可区分为 3 种基本设备类型。每个模块常常实现 3 种类型中的 1 种，因此可分类成字符模块、块模块或者一个网络模块。这种将模块分成不同类型或类别的方法并非是固定不变的。可以选择建立在一个大块代码中实现了不同驱动的巨大模块，但是好的程序员常常创建一个不同的模块给每个它们实现的新功能，因为分解是可伸缩性和可扩张性的关键因素。3 种基本设备类型分类如下：

* 字符设备

> 一个字符( char ) 设备是一种可以当作一个字节流来存取的设备。一个字符驱动负责实现这种行为，这样的驱动常常至少实现 open、close、read 和 write 系统调用。文本控制台( /dev/console )和串口( /dev/ttyS0 )是字符设备的例子，因为它们很好地展现了流的抽象。字符设备通过文件系统结点来存取，例如 /dev/tty1 和 /dev/lp0。在一个字符设备和一个普通文件之间唯一有关的不同就是，，经常可以在普通文件中移来移去，但是大部分字符设备
仅仅是数据通道，只能顺序存取。

* 块设备

> 如同字符设备，块设备通过位于 /dev 目录的文件系统结点来存取。一个块设备(例如一个磁盘)应该是可以驻有一个文件系统的。允许应用程序读写一个块设备象一个字符设备一样，一次传送任意数目的字节。块和字符设备的区别
仅仅在内核在内部管理数据的方式。

* 网络接口

> 任何网络事务都通过一个接口来进行。就是说，一个能够与其他主机交换数据的设备。一个网络接口负责发送和接收数据报文，在内核网络子系统的驱动下，不必知道单个事务是如何映射到实际的被发送的报文上的。很多网络连接( 特别那些使用 TCP 的)是面向流的，但是网络设备却常常设计成处理报文的发送和接收。
一个网络驱动对单个连接一无所知，它只处理报文。既然不是一个面向流的设备，一个网络接口就不像 /dev/tty1 那么容易映射到文件系统的一个结点上。Linux 提供的对接口的存取的方式仍然是通过分配一个名子给它们( 例如 eth0 )，但是这个名子在文件系统中没有对应的入口。内核与网络设备驱动间的通讯与字符和块设备驱动所用的完全不同。不用 read 和 write，内核调用和报文传递相关的函数。