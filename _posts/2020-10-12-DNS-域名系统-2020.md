---
layout:     post
title:      "DNS 域名系统, 2020"
subtitle:   "介绍"
date:       2020-10-12 08:54:00
author:     "Ruer"
header-img: "img/bg/hello_world.jpg"
catalog: true
tags:
    - TCP/IP
---

DNS（Domain Name System，域名系统）是互联网的一项服务。它作为将 Domain 和 IP 地址相互映射的一个分布式数据库，能够使用户更方便地访问互联网。

## 域名结构

为了实现 DNS 首先需要制定一套命名规则，防止 Domain 出现重复。对于整个 Internet 来说，域名层次结构的顶级由 ICANN（互联网名称与数字地址分配机构）负责管理。目前，已经有超过 250 个顶级域名，每个顶级域名可以进一步划为一些子域（二级域名），这些子域可被再次划分（三级域名），依此类推。所有这些域名可以组织成一棵树，如下图所示：

![1](/img/TCP&IP/DNS域名结构.png)

DNS 设计之初是用来建立 Domain 到 IP 地址的映射，理论上对于每一个 Domain 我们只需要在域名服务器上保存一条记录即可。这里的记录一般叫作域名资源记录，它是一个五元组：

```
Domain_name Time_to_live Class Type Value
```

* Domain_name：指出这条记录适用于哪个域名；
* Time_to_live：用来表明记录的生存周期，也就是说最多可以缓存该记录多长时间（后面会讲到缓存机制）；
* Class：一般总是 IN；
* Type：记录的类型；
* Value：记录的值，如果是 A 记录，则 value 是一个 IPv4 地址；如果是 AAAA 记录，则是一个 IPv6 地址。

因为对于一个域名来说，通常并非只记录其 IP 地址，还可能需要一些其他种类的记录，所以需要一个 Type 字段作为标识，一些常见的记录类型如下：

![2](/img/TCP&IP/DNS记录类型.png)

## 域名服务器集群

我们知道不能只用一台域名服务器来响应所有的 DNS 查询，因为没有一台机器能够给全球的用户提供查询服务，计算能力、存储、带宽都不允许。只能合理组织一个域名服务器集群，使他们协同工作，共同提供域名解析服务。

#### 域名区域

接下来首先要面对的一个问题是如何合理地将所有的域名资源记录存储到不同的域名服务器上。前面说过域名的名字空间可以组织为一棵树，这里我们可以进一步将其划分为不重叠的区域（DNS zone），针对上图的域名空间，一种可能的域名划分如下图：

![3](/img/TCP&IP/DNS域名区域.png)

然后将每个区域中的多个域名服务器（其中一个是 Master，其他 Slave 服务器则用来提供数据备份、加快解析速度、保证服务可用性）关联起来，这些域名服务器统称为该区域的 “权威域名服务器（Authoritative Name Servers）”，它保存两类域名资源记录：

1. 该区域内所有域名的域名资源记录。
2. 父区域和子区域的域名服务器对应的域名资源记录（主要是 NS 记录）。

这样，所有的域名资源记录被分散保存在多个域名服务器中，并且所有的域名服务器也组成了一个层次的索引结构。

![4](/img/TCP&IP/DNS域名索引.png)

#### 域名服务器类型

![4](/img/TCP&IP/DNS域名服务器类型.png)

由高向低进行层次划分，可分为以下几大类：

* 根域名服务器：最高层次的域名服务器，也是最重要的域名服务器，本地域名服务器如果解析不了域名就会向根域名服务器求助。全球共有 13 个不同 IP 地址的根域名服务器，它们的名称用一个英文字母命名，从 a 一直到 m。这些服务器由各种组织控制，并由 ICANN（互联网名称和数字地址分配公司）授权，由于每分钟都要解析的名称数量多得令人难以置信，所以实际上每个根服务器都有镜像服务器，每个根服务器与它的镜像服务器共享同一个 IP 地址，中国大陆地区内只有 6 组根服务器镜像。当你对某个根服务器发出请求时，请求会被路由到该根服务器离你最近的镜像服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和地址，如果向根服务器发出对 jocent.me 的请求，则根服务器是不能在它的记录文件中找到与 jocent.me 匹配的记录。但是它会找到 me 的顶级域名记录，并把负责 me 地址的顶级域名服务器的地址发回给请求者。

* 顶级域名服务器：负责管理在该顶级域名服务器下注册的二级域名。当根域名服务器告诉查询者顶级域名服务器地址时，查询者紧接着就会到顶级域名服务器进行查询。比如还是查询 jocent.me，根域名服务器已经告诉了查询者 me 顶级域名服务器的地址，me 顶级域名服务器会找到 jocent.me 的域名服务器的记录，域名服务器检查其区域文件，并发现它有与 jocent.me 相关联的区域文件。在此文件的内部，有该主机的记录。此记录说明此主机所在的 IP 地址，并向请求者返回最终答案。

* 权威域名服务器：负责一个 Domain Zone 的域名解析工作。

* 本地域名服务器：当一个主机发出 DNS 查询请求的时候，这个查询请求首先就是发给本地域名服务器的。

## 域名解析

我们已经有了一个域名服务器集群，该集群合理地保存了域名空间和域名资源记录的对应关系。现在我们要做的就是发送一个 DNS 查询请求给域名服务器，然后坐等它返回正确的域名资源记录，这个过程叫作域名解析。

域名解析的过程最早要追溯到建立网络连接。因为每当连接上网络之后，计算机会自动获得一个默认的 DNS 服务器，当然你也可以用自己信任的 DNS 服务器，比如：8.8.8.8、114.114.114.114。我们把这个域名服务器也叫作本地域名服务器。

接下来当我们需要知道一个域名对应的资源记录时，会向本地域名服务器发起请求，如果该域名恰好在本地域名服务器所辖属的域名区域（DNS Zone）内，那么可以直接返回记录；如果在本地域名服务器没有发现该域名的资源记录，就需要在整个域名空间搜索该域名。而整个域名空间的资源记录存储在一个分层的、树状联系的一系列域名服务器上，所以本地域名服务器首先要从根域名服务器开始往下搜索。

#### 递归查询

递归查询是最常见，也是默认的解析方式。在这种解析方式中，如果客户端配置的本地名称服务器，（又称Local DNS， 可以是默认的运营商提供的Local DNS 或者自己设置的DNS） 不能解析的话，则后面的查询全由本地名称服务器代替DNS客户端进行查询，直到本地名称服务器从权威名称服务器得到了正确的解析结果，然后由本地名称服务器告诉DNS客户端查询的结果。

在这个查询过程中，一直是以本地名称服务器（Local DNS）为中心的，DNS客户端只是发出原始的域名查询请求报文，然后就一直处于等待状态的，直到本地名称服务器发来了最终的查询结果。此时的本地名称服务器就相当于中介代理的作用。如果考虑了本地名称服务器的缓存技术（也就是在DNS服务器上对一定数量的以前查询记录保存一定时间，这样后面查询同样的域名信息时就可直接从缓存中调出来，以加速查询效率）的话，则递归解析的基本流程如下：

> （1）客户端向本机配置的本地名称服务器（在此仅以首选DNS服务器为例进行介绍，所配置其它备用DNS服务器的解析流程完全一样）发出DNS域名查询请求。
> （2）本地名称服务器收到请求后，先查询本地的缓存，如果有该域名的记录项，则本地名称服务器就直接把查询的结果返回给客户端；如果本地缓存中没有该域名的记录，则本地名称服务器再以DNS客户端的角色发送与前面一样的DNS域名查询请求发给根名称服务器。
>（3）根名称服务器收到DNS请求后，把所查询得到的所请求的DNS域名中顶级域名所对应的顶级名称服务器地址返回给本地名称服务器。
>（4）本地名称服务器根据根名称服务器所返回的顶级名称服务器地址，向对应的顶级名称服务器发送与前面一样的DNS域名查询请求。
>（5）对应的顶级名称服务器在收到DNS查询请求后，也是先查询自己的缓存，如果有所请求的DNS域名的记录项，则相接把对应的记录项返回给本地名称服务器，然后再由本地名称服务器返回给DNS客户端，否则向本地名称服务器返回所请求的DNS域名中的二级域名所对应的二级名称服务器地址。

然后本地名称服务器继续按照前面介绍的方法一次次地向三级、四级名称服务器查询，直到最终的对应域名所在区域的权威名称服务器返回到最终的记录给本地名称服务器。然后再由本地名称服务器返回给DNS客户，同时本地名称服务器会缓存本次查询得到的记录项。

#### 迭代查询

所有查询工作全部是DNS客户端自己进行（以“DNS客户端”自己为中心）。在条件之一满足时就会采用迭代名称解析方式：

1. 在查询本地名称服务器时，如果客户端的请求报文中没有申请使用递归查询，即在DNS请求报头部的RD字段没有置1。相当于说“你都没有主动要求我为你进行递归查询，我当然不会为你工作了”。

2. 客户端在DNS请求报文中申请使用的是递归查询（也就是RD字段置1了），但在所配置的本地名称服务器上是禁用递归查询（DNS服务器一般默认支持递归查询的），即在应答DNS报文头部的RA字段置0。

#### 递归和迭代的区别

DNS客户端和本地名称服务器是递归，而本地名称服务器和其他名称服务器之间是迭代。

通过图片看看他们的不同：

![5](/img/TCP&IP/DNS递归查询.png)

![6](/img/TCP&IP/DNS迭代查询.png)

## 使用协议

在绝大多数情况下，DNS 都是使用 UDP 协议进行通信的，DNS 协议在设计之初也推荐我们在进行域名解析时首先使用 UDP，这确实能解决很多需求，但是不能解决全部的问题。

实际上，DNS 不仅使用了 UDP 协议，也使用了 TCP 协议。DNS 查询的类型不止包含 A 记录、CNAME 记录等常见查询，还包含 AXFR 类型的特殊查询，这种特殊查询主要用于 DNS 区域传输，它的作用就是在多个命名服务器之间快速迁移记录，由于查询返回的响应比较大，所以会使用 TCP 协议来传输数据包。